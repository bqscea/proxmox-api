# Proxmox API 自动化功能测试

本目录包含了 Proxmox API 自动化功能模块的测试用例。这些测试用例旨在确保自动化功能的正确性、安全性和性能。

## 测试类概述

### 基础功能测试

- **AutomationTaskTest**: 测试自动化任务基类的核心功能，包括日志记录、任务等待、虚拟机和容器过滤等。

### 具体任务测试

- **BatchVMOperationTaskTest**: 测试批量虚拟机操作任务，包括启动、停止、重启等操作的执行。
- **BatchBackupTaskTest**: 测试批量备份任务，包括备份创建、定时备份和旧备份清理。
- **ResourceMonitorTaskTest**: 测试资源监控任务，包括CPU、内存、磁盘和网络监控，以及阈值检测和警报处理。

### 集成测试

- **IntegrationTest**: 测试多个自动化任务的组合使用，例如先停止虚拟机，然后备份，最后再启动。

### 安全测试

- **SecurityTest**: 测试自动化任务的安全性，包括输入验证、注入防护、权限检查、敏感信息处理等。

### 性能测试

- **PerformanceTest**: 测试自动化任务的性能表现，包括并行与串行执行的对比、大规模环境下的性能等。

### 警报处理器测试

- **AlertHandlersTest**: 专门测试资源监控任务中的警报处理器功能，包括邮件警报、日志警报和自动扩容等。

## 运行测试

可以使用以下命令运行所有测试：

```bash
./vendor/bin/phpunit
```

或者运行特定的测试类：

```bash
./vendor/bin/phpunit tests/Automation/BatchVMOperationTaskTest.php
```

## 测试覆盖率

这些测试用例覆盖了自动化功能模块的以下方面：

1. **功能正确性**: 确保各种自动化任务能够正确执行其预期功能。
2. **错误处理**: 测试在各种错误情况下的行为，如API调用失败、权限不足等。
3. **安全性**: 测试输入验证、注入防护、敏感信息处理等安全相关功能。
4. **性能**: 测试在不同规模和配置下的性能表现。
5. **集成**: 测试多个自动化任务的组合使用。

## 添加新测试

添加新测试时，请遵循以下准则：

1. 为每个新的自动化任务类创建对应的测试类。
2. 使用PHPUnit的模拟功能模拟API调用，避免实际调用Proxmox API。
3. 测试各种边界条件和错误情况。
4. 确保测试覆盖率达到至少80%的代码行覆盖率。
5. 对于性能敏感的功能，添加性能测试。

## 注意事项

- 这些测试用例不会实际调用Proxmox API，而是使用模拟对象模拟API调用。
- 某些测试（如邮件警报测试）可能需要特定的PHP扩展，如果没有这些扩展，相关测试会被跳过。
- 性能测试的结果可能会因运行环境而异。 